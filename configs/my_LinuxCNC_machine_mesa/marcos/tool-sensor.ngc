o<tool-sensor> sub

#<max_probe> = #<_ini[TOOLSENSOR]maxprobe>
#<search_vel> = #<_ini[TOOLSENSOR]search_vel>
#<probe_vel> = #<_ini[TOOLSENSOR]probe_vel>
#<sensor_height_G53> = #<_ini[TOOLSENSOR]height> (probed spindle nose in G53 machine coord.)
#<probed_height_G53> = 0

#<safe_height> = #<_ini[CHANGE_POSITION]Z>
#<fast_move_off> = 2.0
#<dwell_move_off> = 0.5
#<slow_down_probe> = -6 

(print, max_probe is #<max_probe>)
(print, search vel is #<search_vel>)
(print, probe vel is #<probe_vel>)
(print, sensor height is #<sensor_height_G53>)

G21 (use metric units)
G53 G90 G0 Z[#<safe_height>] (raise spindle to Z0)
G53 G90 G0 X#<_ini[TOOLSENSOR]x> Y#<_ini[TOOLSENSOR]y>
G91 (switch to incremental mode)

; this section commented out for sim
G38.2 Z[-#<max_probe>] F#<search_vel> (probe down)
G0 Z[#<fast_move_off>]  (move off sensor)
G4 P[#<dwell_move_off>] (pause for 0.5 sec.)

G38.2 Z[#<slow_down_probe>] F#<probe_vel> (probe down slower)

; calculate in G53 machine coords
#<coord_index> = [#5220 - 1] (0: G54, 1:G55 ...so on)
#<coord_index> = [#<coord_index> * 20] (0 : G54, 20:G55, 40:G56... son)
#<coord_index> = [#<coord_index> + 5223]
(debug, coord_index #<coord_index>)
#<probed_height_G53> = [#5063 + #[#<coord_index>]]
(debug, 5063 #5063)
(debug, probed height is #<probed_height_G53>)
#<_cal_tool_length> = [#<probed_height_G53> - #<sensor_height_G53>]  
(debug, calculated tool length is #<_cal_tool_length>)

O100 IF [#<_cal_tool_length> LT 10]
    M0 (Ask for user handling)
    M1 
    (Debug, Error of tool length #<_cal_tool_length>)
O100 ENDIF

G90 (absolute distance mode)
G53 G0 Z[#<safe_height>] (move Z up to 0)
o<tool-sensor> endsub
